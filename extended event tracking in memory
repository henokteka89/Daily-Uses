-- Drop existing session if it exists
IF EXISTS (SELECT * FROM sys.server_event_sessions WHERE name = 'rpc')
    DROP EVENT SESSION [rpc] ON SERVER;
GO

-- Create optimized in-memory session
CREATE EVENT SESSION [rpc] ON SERVER
ADD EVENT sqlserver.rpc_completed
(
    ACTION(sqlserver.database_id, sqlserver.sql_text, sqlserver.username)
    WHERE (object_name LIKE 'sp_GetPostsByTag' AND cpu_time > 500000)
)
ADD TARGET package0.ring_buffer
WITH (
    MAX_MEMORY = 1024 KB,       -- Reduced memory footprint
    EVENT_RETENTION_MODE = ALLOW_SINGLE_EVENT_LOSS,
    MAX_DISPATCH_LATENCY = 5 SECONDS,  -- Faster dispatch
    MAX_EVENT_SIZE = 0 KB,
    MEMORY_PARTITION_MODE = NONE,
    TRACK_CAUSALITY = OFF,
    STARTUP_STATE = OFF
);
GO
ALTER EVENT SESSION [rpc] ON SERVER STATE = START;
ALTER EVENT SESSION [rpc] ON SERVER STATE = STOP;

-- Query the ring_buffer for captured events
SELECT  
    xevent.value('(data[@name="statement"]/value)[1]', 'nvarchar(max)') AS statement_text,
    --xevent.value('(action[@name="sql_text"]/value)[1]', 'nvarchar(max)') AS sql_text,
    --xevent.value('(action[@name="username"]/value)[1]', 'nvarchar(256)') AS username,
    --xevent.value('(data[@name="database_id"]/value)[1]', 'int') AS database_id,
    --xevent.value('(data[@name="cpu_time"]/value)[1]', 'bigint') AS cpu_time,
    xevent.value('@timestamp', 'datetime2') AS [timestamp]
FROM (
    SELECT CAST(t.target_data AS XML) AS target_xml
    FROM sys.dm_xe_sessions AS s
    JOIN sys.dm_xe_session_targets AS t
        ON s.address = t.event_session_address
    WHERE s.name = 'RPC'
      AND t.target_name = 'ring_buffer'
) AS data
CROSS APPLY target_xml.nodes('//event') AS events(xevent);

