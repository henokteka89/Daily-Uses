/* Queries and Modifications + Table Size */
--rUN PER DB
;WITH UsageStats (object_id, Index_ID, Seek, Scan, LookUp, [Update]) AS (
    SELECT
        T.object_id, Index_Id,
        last_user_seek, last_user_scan, last_user_lookup, last_user_update
    FROM sys.dm_db_index_usage_stats AS I
    INNER JOIN sys.tables AS T ON I.object_id = T.object_id
    WHERE database_id = DB_ID()
),
ReferenceDates (object_id, AccessDate, Operation) AS (
    SELECT object_id, AccessDate, Operation FROM UsageStats
    UNPIVOT
    (AccessDate FOR Operation IN ([Seek], [Scan], [LookUp], [Update])) AS UP
),
LastAccess (object_id, LastDate) AS (
    SELECT object_id, MAX(AccessDate) AS LastDate FROM ReferenceDates
    GROUP BY object_id
),
LastOperations (object_id, LastDate, Operations) AS (
    SELECT LA.*,
        (SELECT DISTINCT Operation FROM ReferenceDates AS R
         WHERE LA.object_id = R.object_id AND LA.LastDate = R.AccessDate
         FOR XML AUTO) AS Operations
    FROM LastAccess AS LA
),
TableSizeMB AS (
    SELECT 
        object_id,
        SUM(reserved_page_count) * 8.0 / 1024 AS SizeMB
    FROM sys.dm_db_partition_stats
    GROUP BY object_id
)

SELECT
    T.name AS TableName,
    -- Format LastAccessDate as string, fallback to 'Never Accessed'
    COALESCE(CONVERT(VARCHAR(19), LO.LastDate, 120), 'Never Accessed') AS LastAccessDate,
    ISNULL(REPLACE(REPLACE(LO.Operations, '"/>', ','), '<R Operation="', ''), 'No Activity') AS LastOperations,
    CONVERT(DECIMAL (10,2), ISNULL(SIZE.SizeMB, 0)) AS TableSizeMB
FROM sys.tables AS T
LEFT JOIN LastOperations AS LO ON T.object_id = LO.object_id
LEFT JOIN TableSizeMB AS SIZE ON T.object_id = SIZE.object_id
ORDER BY 
    LO.LastDate DESC OFFSET 0 ROWS;
GO
